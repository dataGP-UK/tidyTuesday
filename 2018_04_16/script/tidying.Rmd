---
title: "Tidy Tuesday 2018_04_16"
output: html_notebook
---

```{r setup}

library(tidyverse)
library(here)
library(readxl)
library(skimr)
library(janitor)
```

```{r read_xlsx}
global_mortality <- read_excel(path = "2018_04_16/data/global_mortality.xlsx")
```

# Initial Observations

```{r initial_obs}

str(global_mortality)
skim(global_mortality)
```

## Tidy variable names

To make manipulation easier - currently non-syntactic

```{r tidy_colnames}

global_mortality <- rename_with(global_mortality, function(x){
  str_remove_all(x, "( \\(%\\))|\\(|\\)") %>% 
    tolower %>% 
    str_replace_all(" |\\/|-", "_")
})

names(global_mortality)
```

## Missing values

### Explicit

#### country_codes

864 country_codes 'missing'.

Also maximum length is 8 characters - I thought all codes are 3 letters so need to explore what codes \>3 characters represent.

```{r country_codes_NA}
# what does country_code N/A represent?
na_country_code <- 
  global_mortality[which(is.na(global_mortality$country_code)),] %>% 
  pull(country) %>% 
  unique
na_country_code
# vector created to use when filtering global_mortality dataset
```

These are further groupings of countries that may be useful for further analysis.

```{r country_codes_>3}
# check country codes > 3 characters
global_mortality %>% 
  select(starts_with("country")) %>% 
  mutate(chars = nchar(country_code)) %>% 
  filter(!is.na(country_code) & chars > 3) %>% 
  distinct()
```

All are 3 letters except "World" with country_code "OWID_WRL"

#### year

```{r check_years}

unique(global_mortality$year)
```

27 years - no gaps in data. From 1990 to 2016.

#### terrorism/conflict

1398 observations missing in both categories.

Explore which countries/ years this applies to and whether should be N/A or zero.

```{r terror_conflict_NA}

terror_NA <- is.na(global_mortality$terrorism)
conflict_NA <- is.na(global_mortality$conflict)
                     
# check if missing data relates to same observations
identical(terror_NA, conflict_NA)

global_mortality[terror_NA,] %>% 
  select(starts_with("country"), "year", contains(c("conflict", "terrorism"))) %>% 
  group_by(year) %>% 
  tally()

```

```{r no_conflict_terror_data_all_years}

global_mortality[terror_NA,] %>% 
  select(starts_with("country"), "year", contains(c("conflict", "terrorism"))) %>% 
  group_by(country) %>% 
  tally %>% 
  filter (n > 1)
```

```{r no_conflict_terror_1993}
global_mortality %>% 
  filter(year == 1993) %>% 
  select(starts_with("country"), "year", contains(c("conflict", "terrorism"))) %>% 
  filter (is.na(conflict)) 
```

45 countries where there is no data for any years relating to mortality from conflict or terrorism.

In the year 1993 - all 228 countries had no data for either of these categories. Not evident why this was the case.

------------------------------------------------------------------------

### Implicit

#### Is mortality data complete?

Check if the mortality figures for each country and year add up to 100% . Are there deaths where cause not evident or recorded. How does this vary between countries and years.

```{r calculate_unspecified}
# subtract % of all causes from 100 for each country and year
global_mortality <-
  global_mortality %>%
  mutate(unspecified = 100 - rowSums(across(cardiovascular_diseases:terrorism),
                                       na.rm = T))
```

```{r}
global_mortality %>% 
  group_by(country) %>% 
  summarise(unspecified = sum(unspecified, na.rm = TRUE)) %>% 
  filter(unspecified < 0) %>% 
  mutate(country = fct_reorder(country, unspecified)) %>% 
  ggplot(aes(y = country, x = unspecified))+
  geom_col()
```

There appear to be some 10 countries where mortality adds up to more than 100%. This will affect the validity of results including these countries. Further exploration of their data is indicated.

```{r North_Korea}
NK <- global_mortality %>% 
  filter(country == "North Korea" & unspecified < 0)
NK
```

It appears that deaths from 'nutritional_deficiencies' and 'protein-energy_malnutrition' may be double counted resulting in total mortality \>100%. Q: is it valid to remove 'protein-energy_malnutrition' as a variable??

```{r}
NK %>% 
  ggplot(aes(x = protein_energy_malnutrition, y = nutritional_deficiencies))+
  geom_point()+
  geom_abline()
```

Explore across entire data set to see if this pattern is repeated.

#### Exploration of correlation between variables

```{r correlation_matrix}
cor_mortality <- cor(global_mortality[, c("nutritional_deficiencies", 
                         "protein_energy_malnutrition",
                         "lower_respiratory_infections", "tuberculosis",
                         "respiratory_diseases", "diarrheal_diseases",
                         "digestive_diseases", "intestinal_infectious_diseases",
                         "heat_related_hot_and_cold_exposure", "fire",
                         "natural_disasters")])

```

```{r}
corrplot::corrplot(corr = cor_mortality)
```

Strong correlation across entire dataset between "nutritional_deficiencies" and "protein-energy_malnutrition". Seems reasonable to remove the more specific "protein-energy_malnutrition" variable on the assumption that these deaths are included under "nutritional_deficiencies

```{r remove_redundant_variable}
#check that mortality from nutritional_deficiencies is > that from protein_energy_malnutrition across the data set

global_mortality %>%
  filter(protein_energy_malnutrition > nutritional_deficiencies)
# zero cases so this is further evidence of 'double counting'

global_mortality$protein_energy_malnutrition <- NULL
```

#### Re-evaluate mortality data completeness

Now repeat previous code to assess completeness of data across rows

```{r}
global_mortality <-
  global_mortality %>%
  mutate(unspecified = 100 - rowSums(across(cardiovascular_diseases:terrorism),
                                       na.rm = T))
```

```{r}
global_mortality %>% 
  group_by(country) %>% 
  summarise(unspecified = sum(unspecified, na.rm = TRUE)) %>% 
  filter(unspecified < 0) %>% 
  mutate(country = fct_reorder(country, unspecified)) %>% 
  ggplot(aes(y = country, x = unspecified))+
  geom_col()
```

Mauritius is still an outlier.

```{r Mauritius}
global_mortality %>% 
  filter(country == "Mauritius" & unspecified < 0) 

```

Most years report total mortality \>100% - no obvious pattern. Explore further with correlation matrix

```{r}

global_mortality %>% 
  filter(country == "Mauritius") %>% 
  select(contains(c("neonatal_deaths","lower_respiratory_infections", "meningitis", "intestinal_infectious_diseases", "diarrheal_diseases"))) %>% 
  cor() %>% 
  corrplot::corrplot()
```

May be neonatal deaths resulting in double counting for cause of death i.e. infection vs. type of death ie. neonatal.

Explore across entire dataset to explore if a wider issue

```{r}
global_mortality %>% 
  select(contains(c("neonatal_deaths","lower_respiratory_infections", "meningitis", "intestinal_infectious_diseases", "diarrheal_diseases"))) %>% 
  cor() %>% 
  corrplot::corrplot()
```

Some correlation exists but not as strong as for Mauritius. Not enough evidence to remove any data.

```{r}
global_mortality[global_mortality$unspecified < 0, ] %>% 
  group_by(country) %>%
  tally() %>% 
  mutate(country = fct_reorder(country, n)) %>% 
    ggplot(aes(x = n, y = country)) +
    geom_col()
```

```{r}
global_mortality[global_mortality$unspecified < 0, ] %>% 
  group_by(year) %>%
  tally()  %>% 
  ggplot(aes(y = n, x = year))+
  geom_bar(stat = "identity")
```

#### Discussion

There appears to be considerable variation between different countries as to how causes of death are recorded. This seems to result in deaths being attributed to more than one cause in a significant number of observations. The number of observations where combined mortality is \>100% has increased over time. This may be a result of how data is collected.

## Saving data

### Create longer version

```{r pivot_longer}

global_mortality_long <- 
  global_mortality %>% 
    pivot_longer(data = ., 
                 cols = -c(1:3),
                 names_to = "causes", 
                 values_to = "percent_total")


# global_mortality %>% select(-c(1:3))
```

#### Save objects as binary files

```{r save_tidy_data, eval = FALSE}
save(... = global_mortality_long, 
     file = "2018_04_16/data/global_mortality_long.rda")

save(... = global_mortality, 
     file = "2018_04_16/data/global_mortality.rda")
```

#### Save master file as csv

```{r eval=FALSE}
write_csv(global_mortality, "2018_04_16/data/global_mortality.csv")

```

#### Subset master file and save

```{r all_countries, eval=FALSE}
all_countries_mortality <- 
  global_mortality %>% 
  filter(!country %in% na_country_code)

save(... = all_countries_mortality, file = "2018_04_16/data/all_countries_mortality.rda")

all_countries_mortality_long <- 
  global_mortality_long %>% 
  filter(!country %in% na_country_code)

save(... = all_countries_mortality_long, file = "2018_04_16/data/all_countries_mortality_long.rda")
```

```{r grouped, eval=FALSE}
grouped_mortality_long <- 
  global_mortality_long %>% 
  filter(country %in% na_country_code & !country %in% c("England", "Wales", 
                                 "Scotland", "Northern Ireland"))

save(... = grouped_mortality_long, file = "2018_04_16/data/grouped_mortality_long.rda")

grouped_mortality <- 
  global_mortality %>% 
  filter(country %in% na_country_code & !country %in% c("England", "Wales", 
                                 "Scotland", "Northern Ireland"))

save(... = grouped_mortality, file = "2018_04_16/data/grouped_mortality.rda")
```

```{r UK, eval=FALSE}
united_kingdom <- 
  global_mortality_long %>% 
  filter(country %in% c("United Kingdom", "England", "Scotland", "Wales",
                        "Northern Ireland", "Western Europe", "World"))

save(... = united_kingdom, file = "2018_04_16/data/united_kingdom_mortality.rda")
```

## Tidy up environment

```{r}
rm(cor_mortality, NK, conflict_NA, terror_NA, na_country_code)
```

## 
